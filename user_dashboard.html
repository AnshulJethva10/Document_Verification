{% extends 'base.html' %}

{% block title %}User Dashboard - BlockVerify{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-md-12">
            <h1 class="fw-bold"><i class="fas fa-tachometer-alt text-primary me-2"></i> User Dashboard</h1>
            <p class="lead">Welcome back, {{ session.username }}! View your verified documents.</p>
        </div>
    </div>
    
    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="stats-card">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3 class="h5 mb-0">Total Documents</h3>
                    <div class="bg-primary bg-opacity-10 rounded-circle p-2">
                        <i class="fas fa-file-alt text-primary"></i>
                    </div>
                </div>
                <div class="stats-value">{{ documents|length }}</div>
                <div class="stats-label">Verified documents</div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stats-card">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3 class="h5 mb-0">Issuers</h3>
                    <div class="bg-success bg-opacity-10 rounded-circle p-2">
                        <i class="fas fa-building text-success"></i>
                    </div>
                </div>
                {% set unique_issuers = [] %}
                {% for doc in documents %}
                    {% if doc.issuer_id not in unique_issuers %}
                        {% set _ = unique_issuers.append(doc.issuer_id) %}
                    {% endif %}
                {% endfor %}
                <div class="stats-value">{{ unique_issuers|length }}</div>
                <div class="stats-label">Unique issuers</div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stats-card">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3 class="h5 mb-0">Recent Activity</h3>
                    <div class="bg-info bg-opacity-10 rounded-circle p-2">
                        <i class="fas fa-clock text-info"></i>
                    </div>
                </div>
                {% if documents %}
                    {% set latest = documents|sort(attribute='timestamp', reverse=True)|first %}
                    <div class="stats-value">{{ latest.timestamp|datetime|truncate(10, True, '') }}</div>
                    <div class="stats-label">Latest document received</div>
                {% else %}
                    <div class="stats-value">-</div>
                    <div class="stats-label">No documents received yet</div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Documents Cards -->
    <h2 class="h4 mb-3"><i class="fas fa-file-alt me-2"></i> Your Verified Documents</h2>
    
    {% if documents %}
    <div class="row">
        {% for doc in documents|sort(attribute='timestamp', reverse=True) %}
        <div class="col-lg-6 col-xl-4 mb-4">
            <div class="card h-100 document-card">
                <div class="card-header bg-white d-flex align-items-center">
                    <div class="bg-light rounded p-2 me-3">
                        {% set ext = doc.filename.split('.')[-1].lower() %}
                        {% if ext in ['pdf'] %}
                            <i class="fas fa-file-pdf text-danger"></i>
                        {% elif ext in ['doc', 'docx'] %}
                            <i class="fas fa-file-word text-primary"></i>
                        {% elif ext in ['jpg', 'jpeg', 'png'] %}
                            <i class="fas fa-file-image text-success"></i>
                        {% else %}
                            <i class="fas fa-file-alt text-secondary"></i>
                        {% endif %}
                    </div>
                    <div class="text-truncate">
                        <h5 class="card-title mb-0 text-truncate">{{ doc.filename }}</h5>
                    </div>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-3">
                        <div>
                            <small class="text-muted d-block mb-1">Issued by</small>
                            {% set issuer = User.query.get(doc.issuer_id) %}
                            <span class="fw-medium">{{ issuer.organization or issuer.username }}</span>
                        </div>
                        <div class="text-end">
                            <small class="text-muted d-block mb-1">Date issued</small>
                            <span class="fw-medium">{{ doc.timestamp|datetime|truncate(10, True, '') }}</span>
                        </div>
                    </div>
                    
                    <div class="bg-light rounded p-2 mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">Hash (first 10)</small>
                            <span class="badge bg-dark">{{ doc.file_hash[:10] }}...</span>
                        </div>
                    </div>
                    
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <span class="badge bg-primary">Block #{{ doc.block_index }}</span>
                        </div>
                        
                        <a href="/verify_document" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-check-circle me-1"></i> Verify
                        </a>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="card">
        <div class="card-body py-5 text-center">
            <div class="mb-3">
                <i class="fas fa-file-alt text-muted" style="font-size: 4rem;"></i>
            </div>
            <h3 class="h4 mb-3">No Documents Yet</h3>
            <p class="text-muted">You don't have any verified documents yet.</p>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

### Improved Verification Page (verify_document.html)
Replace the existing verification page with this enhanced version:
```html
{% extends 'base.html' %}

{% block title %}Verify Document - BlockVerify{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row">
        <div class="col-md-8 offset-md-2 text-center mb-5">
            <h1 class="fw-bold"><i class="fas fa-check-circle text-primary me-2"></i> Document Verification</h1>
            <p class="lead">Upload a document to verify its authenticity on the blockchain</p>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8 offset-lg-2">
            <div class="card">
                <div class="card-body p-4">
                    <form method="POST" action="/verify_document" enctype="multipart/form-data" class="text-center">
                        <div class="upload-area mb-4" id="uploadArea">
                            <i class="fas fa-file-upload upload-icon"></i>
                            <h3 class="h5 mb-3">Drag and drop your document or click to browse</h3>
                            <p class="text-muted mb-3">Allowed formats: PDF, DOC, DOCX, PNG, JPG, JPEG</p>
                            <input type="file" class="form-control d-none" id="document" name="document" required>
                            <button type="button" class="btn btn-outline-primary" id="browseBtn">
                                <i class="fas fa-folder-open me-2"></i> Browse Files
                            </button>
                        </div>
                        
                        <div id="fileSelected" class="alert alert-success d-none">
                            <i class="fas fa-file-alt me-2"></i> <span id="fileName">No file selected</span>
                        </div>
                        
                        <button type="submit" class="btn btn-primary btn-lg px-5">
                            <i class="fas fa-search me-2"></i> Verify Document
                        </button>
                    </form>
                </div>
            </div>

            <div class="card mt-5">
                <div class="card-body p-4">
                    <h3 class="card-title mb-4">How Document Verification Works</h3>
                    <div class="row g-4">
                        <div class="col-md-4">
                            <div class="text-center">
                                <div class="bg-light rounded-circle mx-auto mb-3 d-flex align-items-center justify-content-center" style="width: 80px; height: 80px;">
                                    <i class="fas fa-upload fs-2 text-primary"></i>
                                </div>
                                <h4 class="h5">1. Upload</h4>
                                <p class="text-muted">Upload the document you want to verify</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center">
                                <div class="bg-light rounded-circle mx-auto mb-3 d-flex align-items-center justify-content-center" style="width: 80px; height: 80px;">
                                    <i class="fas fa-fingerprint fs-2 text-primary"></i>
                                </div>
                                <h4 class="h5">2. Hash Check</h4>
                                <p class="text-muted">System calculates document fingerprint</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center">
                                <div class="bg-light rounded-circle mx-auto mb-3 d-flex align-items-center justify-content-center" style="width: 80px; height: 80px;">
                                    <i class="fas fa-check-double fs-2 text-primary"></i>
                                </div>
                                <h4 class="h5">3. Verify</h4>
                                <p class="text-muted">Blockchain confirms authenticity</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('document');
        const browseBtn = document.getElementById('browseBtn');
        const fileSelected = document.getElementById('fileSelected');
        const fileName = document.getElementById('fileName');
        
        // Click events
        uploadArea.addEventListener('click', function() {
            fileInput.click();
        });
        
        browseBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            fileInput.click();
        });
        
        // File selection
        fileInput.addEventListener('change', function() {
            if (this.files.length > 0) {
                fileName.textContent = this.files[0].name;
                fileSelected.classList.remove('d-none');
                uploadArea.classList.add('border-success');
            }
        });
        
        // Drag and drop
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        ['dragenter', 'dragover'].forEach(eventName => {
            uploadArea.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, unhighlight, false);
        });

        function highlight() {
            uploadArea.classList.add('border-primary');
        }

        function unhighlight() {
            uploadArea.classList.remove('border-primary');
        }
        
        uploadArea.addEventListener('drop', handleDrop, false);
        
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            if (files.length > 0) {
                fileInput.files = files;
                fileName.textContent = files[0].name;
                fileSelected.classList.remove('d-none');
                uploadArea.classList.add('border-success');
            }
        }
    });
</script>
{% endblock %}

### Enhanced Verification Result Page (verify_result.html)
```html
{% extends 'base.html' %}

{% block title %}Verification Result - BlockVerify{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row">
        <div class="col-lg-8 offset-lg-2 text-center mb-4">
            <h1 class="fw-bold">Document Verification Result</h1>
            <p class="lead text-muted">The results of your document verification check</p>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8 offset-lg-2">
            <div class="card verification-result animated">
                {% if result.verified %}
                <div class="text-center my-4">
                    <div class="verification-badge bg-success text-white mx-auto">
                        <i class="fas fa-check-circle"></i> VERIFIED
                    </div>
                    <h2 class="h3">This document is authentic and has been verified on the blockchain</h2>
                </div>
                
                <div class="row mb-4">
                    <div class="col-md-10 offset-md-1">
                        <div class="table-responsive">
                            <table class="table table-borderless">
                                <tbody>
                                    <tr>
                                        <th class="text-start">
                                            <i class="fas fa-building text-primary me-2"></i> Issued By:
                                        </th>
                                        <td class="text-start fw-medium">{{ result.issuer }}</td>
                                    </tr>
                                    <tr>
                                        <th class="text-start">
                                            <i class="fas fa-landmark text-primary me-2"></i> Organization:
                                        </th>
                                        <td class="text-start fw-medium">{{ result.organization }}</td>
                                    </tr>
                                    <tr>
                                        <th class="text-start">
                                            <i class="fas fa-user text-primary me-2"></i> Issued To:
                                        </th>
                                        <td class="text-start fw-medium">{{ result.user }}</td>
                                    </tr>
                                    <tr>
                                        <th class="text-start">
                                            <i class="fas fa-calendar-alt text-primary me-2"></i> Issued On:
                                        </th>
                                        <td class="text-start fw-medium">{{ result.timestamp|datetime }}</td>
                                    </tr>
                                    <tr>
                                        <th class="text-start">
                                            <i class="fas fa-cubes text-primary me-2"></i> Block Number:
                                        </th>
                                        <td class="text-start fw-medium">{{ result.block_index }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div class="mt-3 bg-light p-3 rounded">
                    <h4 class="h5 mb-3"><i class="fas fa-info-circle me-2"></i> What does this mean?</h4>
                    <p class="mb-0">This document has been cryptographically verified as authentic. The digital signature on this document matches the one securely stored on our blockchain at the time of issuance. This verification confirms that the document has not been tampered with since it was issued.</p>
                </div>
                {% else %}
                <div class="text-center my-4">
                    <div class="verification-badge bg-danger text-white mx-auto">
                        <i class="fas fa-times-circle"></i> NOT VERIFIED
                    </div>
                    <h2 class="h3">This document could not be verified</h2>
                    <p class="text-danger mb-2"><i class="fas fa-exclamation-triangle me-2"></i> {{ result.reason }}</p>
                    <p class="text-muted">The document you uploaded could not be authenticated on our blockchain.</p>
                </div>
                
                <div class="mt-3 bg-light p-3 rounded">
                    <h4 class="h5 mb-3"><i class="fas fa-question-circle me-2"></i> What could have happened?</h4>
                    <ul class="text-start">
                        <li>The document may have never been registered on our blockchain</li>
                        <li>The document may have been modified since it was issued</li>
                        <li>The document may have been issued on a different verification system</li>
                        <li>There might be an issue with the file format or document upload</li>
                    </ul>
                </div>
                {% endif %}
                
                <div class="text-center my-4">
                    <a href="/verify_document" class="btn btn-primary">
                        <i class="fas fa-redo me-2"></i> Verify Another Document
                    </a>
                    <a href="/" class="btn btn-outline-secondary ms-2">
                        <i class="fas fa-home me-2"></i> Back to Home
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}